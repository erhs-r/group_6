---
title: "Larimer County, Colorado - COVID Cases and Socioeconomic Status"
author: "Kailee Reed, Breanna Wenck, and Rebecca Witinok-Huber"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

Inputs {.sidebar}
----------------------------------------------------------------------------

```{r text}

# Larimer County COVID 19 cases and deaths data can be found #[here](https://www.larimer.org/health/communicable-disease/coronavirus-covid-19/larimer-county-positive-covid-19-numbers). 
# COVID-19 State Policies can be found [here](https://healthdata.gov/dataset/covid-19-state-and-county-policy-orders).
# Income and Poverty Census data can be found [here](https://data-cdphe.opendata.arcgis.com/datasets/). 
# 
# The interactive map details the number of COVID-19 cases and deaths per city in 
# Larimer County from March 2020 to November 2020. The overlay toggle allows the 
# tracts to be visualized individually or all together. 
# 
# The following maps represent population density, income, and poverty levels 
# of each city within Larimer County. The size of each point represents the 
# number of COVID-19 cases (March-December 2020) by city. Larger dots mean that 
# that city has had more cases when compared to cities with smaller dots.
# 
# While these figures don't test for statistical significance of associations, 
# they allow us to visually explore spatial patterns in the data.
# 
# We can see that the number of cases were higher in cities with larger 
# populations including Fort Collins and Loveland. Income and poverty together 
# show that cities with lower mean income have higher poverty levels and vice versa. 
# 
# Note. These data are pulled from the 2010 census and we discovered that they 
# are off by a magnitude of ten. For example, the 2010 population in 
# Fort Collins, CO was 120,000 people, not 12,000 people.
```


``````{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r load_data}
library(flexdashboard)
library(tidyverse)
library(magrittr)
library(tigris)
library(na.tools)
library(lubridate)
library(viridis)
library(leaflet)
library(ggplot2)
library(ggrepel)
library(ggthemes)

state_policy <- read_csv("raw_data/state_policy_updates_20201122_0721.csv")
LC_covid <- read_csv("raw_data/LC-COVID-casesdata.csv")
covid_deaths <- read_csv("raw_data/covid_deaths.csv")
income <- read_csv("raw_data/Income_Poverty__Census_Tracts_.csv")

### Pull census data for Larimer county 
larimer_tracts <- tracts(state = 08, county =069, 
                        cb = TRUE, class = "sf", progress_bar = FALSE)

larimer_income <- income %>%
  filter(County == "LARIMER")

larimer_info <- full_join(larimer_income, larimer_tracts, 
                          by = list(x = "FIPS", y = "GEOID"))
```


Column {data-width=650}
-----------------------------------------------------------------------

### Interactive map of Covid cases and deaths in Larimer County, Colorado


```{r data_manipulation}

### Make all city names in title format to join data sets

LC_covid <- LC_covid %>% 
  mutate(City = str_to_title(City))

### Create vectors of gps coordinates of cities from information collected from
### the internet

Lat <- c(40.625679, 40.284667, 40.431269, 40.377117, 40.559167, 40.453740, 
         40.336944, 40.633808, 40.794319, 40.404789, 40.487171, 40.807820, 
         40.529718, 40.702324, 40.477222)

Lon <- c(-105.171089, -104.965504, -105.339661, -105.525514, -105.078056, 
         -105.448837, -104.912222, -105.148819, -105.216579, -105.085868, 
         -105.210056, -105.578641, -104.981654, -105.005497, -104.911944)

City <- c("Bellvue", "Berthoud", "Drake", "Estes Park",
          "Fort Collins", "Glen Haven", "Johnstown", "Laporte", "Livermore",
          "Loveland", "Masonville", "Red Feather Lakes", "Timnath", 
          "Wellington", "Windsor")

### Combine the vectors into a data frame and then join the data sets so cities
### have coordinates associated with them for mapping and remove NA values

larimer_gps <- data.frame(City, Lat, Lon)

LC_covid_gps <- full_join(larimer_gps, LC_covid, by = "City") %>% 
  na.rm()

LC_covid_gps <- LC_covid_gps %>% 
  mutate(ReportedDate = mdy(ReportedDate)) 

LC_covid_gps <- LC_covid_gps %>%
  mutate(popup_info = paste("<b>Location:</b>", City, "<br/>",
                            "<b>Age:</b>", Age, "<br/>",
                            "<b>Date:</b>", ReportedDate, "<br/>",
                            "<b>Total # of cases:</b>", CaseCount))

total_covid_per_city <- LC_covid %>% 
  group_by(City) %>% 
  count()

total_covid <- full_join(total_covid_per_city, larimer_gps, by = "City") %>% 
  na.rm()

### Provide covid deaths with coordinates

covid_deaths <- full_join(larimer_gps, covid_deaths, 
                          by = list(x = "City", y = "city")) %>% 
  na.rm()

covid_deaths_total <- covid_deaths %>% 
  group_by(City) %>% 
  count()

mean_age_deaths <- covid_deaths %>% 
  group_by(City) %>% 
  summarize(mean_age = mean(age), .groups = "drop")

mean_age_deaths <- full_join(mean_age_deaths, covid_deaths_total, by = "City")

mean_age_deaths <- full_join(larimer_gps, mean_age_deaths, by = "City") %>% 
  na.rm() %>% 
  mutate(popup_info = paste("<b>Location:</b>", City, "<br/>",
                            "<b>Number of deaths:</b>", n, "<br/>",
                            "<b>Mean age of death:</b>", mean_age))

### Create a popup column to with plot images to merge 

popup_info <- c("<img src = images/Bellvue.svg>",
                "<img src = images/Berthoud.svg>", 
                "<img src = images/Drake.svg>",
                "<img src = images/EP.svg>",
                "<img src = images/FC.svg>",
                "<img src = images/GH.svg>",
                "<img src = images/Johnstown.svg>",
                "<img src = images/Laporte.svg>",
                "<img src = images/Livermore.svg>",
                "<img src = images/Loveland.svg>",
                "<img src = images/Masonville.svg>",
                "<img src = images/RFL.svg>",
                "<img src = images/Timnath.svg>",
                "<img src = images/Wellington.svg>",
                "<img src = images/Windsor.svg>")

plots <- data.frame(City, popup_info)

total_covid <- full_join(total_covid, plots, by = "City")

### Add icon to differentiate between cases and deaths

obit_icon <- makeIcon("images/icons8-obituary-30.png", 
                      iconWidth = 15, iconHeight = 15)

covid_icon <- makeIcon("images/icons8-coronavirus-64.png",
                       iconWidth = 15, iconHeight = 15)

leaflet() %>%
  addTiles() %>%
  addPolygons(data = larimer_tracts, color = "#000000", 
              fillColor = "969696", weight = 2, 
              group = "tracts") %>% 
  addMarkers(data = total_covid,
             lat = ~Lat, 
             lng = ~Lon,
             icon = ~covid_icon,
             popup = ~popup_info,
             group = "cases")%>% 
  addMarkers(data = mean_age_deaths,
             lng = ~ Lon, 
             lat = ~ Lat,
             popup = ~ popup_info, 
             icon = ~obit_icon,
             group = "deaths") %>% 
  addLayersControl(baseGroups = c("base map"),
                   overlayGroups = c("tracts", "cases", "deaths"))

```


Column {data-width=550}
-----------------------------------------------------------------------

### Income and Poverty Maps for Larimer County, Colorado

```{r income-poverty-maps}
#Creating a new dataset with fewer variables
larimer_short <- larimer_info %>%
  select(Population_Total:Poverty_Per_Capita_Income, TRACTCE)

#Join income vars with larimer_tracts by "TRACTCE", now income vars have coords
tracts_income <- larimer_tracts %>% left_join(.,larimer_short, by = "TRACTCE") 

#figure for larimer county population totals
#larimer_tracts %>% left_join(.,larimer_short, by = "TRACTCE") 
  
  tracts_income %>%
  ggplot() +
  geom_sf(aes(fill = Population_Total)) +
  geom_point(data = larimer_gps %>%
               filter(City!="Cedaredge"), aes(x=Lon, y=Lat)) +
               geom_text_repel(data = larimer_gps %>%
                        filter(City!="Cedaredge"), 
                        aes(x=Lon, y=Lat, 
                        label = City), color = "black",
                        show.legend=NA, 
                        nudge_x = .1, nudge_y = .1) +
  scale_fill_viridis(name = "City Population", direction = -1, option = "cividis") +
  ggtitle("Population Totals for Cities in Larimer County") 

#Figure for income
tracts_income %>%
  ggplot() +
  geom_sf(aes(fill = Poverty_Mean_Household_Income)) +
  geom_point(data = larimer_gps %>%
               filter(City!="Cedaredge"), aes(x=Lon, y=Lat)) +
               geom_text_repel(data = larimer_gps %>%
                        filter(City!="Cedaredge"), 
                        aes(x=Lon, y=Lat, 
                        label = City), color = "black",
                        show.legend=NA, 
                        nudge_x = .1, nudge_y = .1) +
  ggtitle("Mean Income for Larimer County") +
  scale_fill_viridis(name = "Income (USD)", direction = -1, option = "cividis")

#Figure for pov per capita income
tracts_income %>%
  ggplot() +
  geom_sf(aes(fill = Poverty_Per_Capita_Income)) +
  geom_point(data = larimer_gps %>%
               filter(City!="Cedaredge"), aes(x=Lon, y=Lat)) +
               geom_text_repel(data = larimer_gps %>%
                        filter(City!="Cedaredge"), 
                        aes(x=Lon, y=Lat, 
                        label = City), color = "black",
                        show.legend=NA, 
                        nudge_x = .1, nudge_y = .1) +
  ggtitle("Poverty Per Capita Income for Larimer County") +
  scale_fill_viridis(name = "Number of People", direction = -1, option = "cividis")

#Percent of population below poverty levels
tracts_income %>%
  ggplot() +
  geom_sf(aes(fill = Percent_Poverty_AllPeople_Income_Below_Pov_Level)) +
  geom_point(data = larimer_gps %>%
               filter(City!="Cedaredge"), aes(x=Lon, y=Lat)) +
               geom_text_repel(data = larimer_gps %>%
                        filter(City!="Cedaredge"), 
                        aes(x=Lon, y=Lat, 
                        label = City), color = "black",
                        show.legend=NA, 
                        nudge_x = .1, nudge_y = .1) +
  ggtitle("Percent of Larimer County Below the Poverty Level") +
  scale_fill_viridis(name = "Percent", direction = -1, option = "cividis")
```


### Total COVID Cases in Larimer County 

```{r load_dataset, echo=FALSE}

#Load dataset 

lc_covid <- read.csv("raw_data/LC-COVID-casesdata.csv")
```

```{r setup, manipulate_data}

# Group by reported date (combining to make total COVID cases)
total_covid <- lc_covid %>%
  group_by(ReportedDate) %>%
  count()

# Check the class before mutating 
#class(x = total_covid$ReportedDate)

# Mutate to mdy 
total_covid <- mutate(.data = total_covid, 
                      date = mdy(ReportedDate))

# Group by month 
month_covid <- total_covid %>%
  group_by(month = floor_date(date, "day")) %>%
  summarise(n=sum(n), .groups = "drop")
```

```{r setup, graph_data, fig.width=8, fig.height=5}

# Plot date and totals with line graph and important dates

total_covid %>%
  ggplot() + 
  geom_line(aes(x = date, y = n)) + 
  scale_x_date(date_labels = " %b", date_breaks = "1 month") +
  theme_clean() +
  geom_vline(xintercept= as.Date("2020-11-10"), color="red", size=.5) +
  geom_vline(xintercept = as.Date("2020-03-25"), color = "blue", size = .5) +
  geom_text(aes(x=as.Date("2020-11-10"), label="Election Season", y=250), colour="red", angle=90, vjust = -1, text=element_text(size=10)) + 
    geom_text(aes(x=as.Date("2020-03-25"), label="Stay at Home Order", y=200), colour="blue", angle=90, vjust = -1, text=element_text(size=10)) + 
  ggtitle("Larimer County COVID-19 cases from March to December") + 
  xlab("Month of Confirmed Cases") + 
  ylab("Total COVID Cases Confirmed")
```

