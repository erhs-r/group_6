---
title: "Income and poverty mapping"
author: "Rebecca Witinok-Huber"
date: "12/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, CB = FALSE)
```


```{r load_data}
library(tidyverse)
library(ggplot2)
library(tigris)
library(na.tools)
library(lubridate)
library(leaflet)
library(ggrepel)
library(viridis)
library(plotly)
library("ggpubr")

#state_policy <- read_csv("raw_data/state_policy_updates_20201122_0721.csv")
LC_covid <- read_csv("raw_data/LC-COVID-casesdata.csv")
covid_deaths <- read_csv("raw_data/covid_deaths.csv")
income <- read_csv("raw_data/Income_Poverty__Census_Tracts_.csv")

### Pull census data for Larimer county 

larimer_tracts <- tracts(state = 08, county =069, 
                        cb = TRUE, class = "sf")
```


```{r data_manipulation}
### Filter the income data to just Larimer county

larimer_income <- income %>%
  filter(County == "LARIMER")

### Join the data sets 

larimer_info <- full_join(larimer_income, larimer_tracts, 
                          by = list(x = "FIPS", y = "GEOID"))

### Make all city names in title format to join data sets

LC_covid <- LC_covid %>% 
  mutate(City = str_to_title(City))

### Create vectors of gps coordinates of cities from information collected from
### the internet

Lat <- c(40.625679, 40.284667, 38.894137, 40.431269, 40.377117, 40.559167, 
         40.453740, 40.336944, 40.633808, 40.794319, 40.404789, 40.487171,
         40.807820, 40.529718, 40.702324, 40.477222)

Lon <- c( -105.171089, -104.965504, -107.925498, -105.339661, -105.525514,
          -105.078056, -105.448837, -104.912222, -105.148819, -105.216579,
          -105.085868, -105.210056,-105.578641, -104.981654, 
          -105.005497, -104.911944)

City <- c("Bellvue", "Berthoud", "Cedaredge", "Drake", "Estes Park",
          "Fort Collins", "Glen Haven", "Johnstown", "Laporte", "Livermore",
          "Loveland", "Masonville", "Red Feather Lakes", "Timnath", 
          "Wellington", "Windsor")

### Combine the vectors into a data frame and then join the data sets so cities
### have coordinates associated with them for mapping and remove NA values

larimer_gps <- data.frame(City, Lat, Lon)

LC_covid_gps <- full_join(larimer_gps, LC_covid, by = "City") %>% 
  na.rm()

LC_covid_gps <- LC_covid_gps %>% 
  mutate(ReportedDate = mdy(ReportedDate)) 

LC_covid_gps <- LC_covid_gps %>% 
  mutate(month = month(ReportedDate, label = TRUE,
                     abbr = FALSE),
       weekday = wday(ReportedDate, label = TRUE,
                      abbr = FALSE)) %>% 
  mutate(popup_info = paste("<b>Location:</b>", City, "<br/>",
                            "<b>Age:</b>", Age, "<br/>",
                            "<b>Date:</b>", ReportedDate, "<br/>",
                            "<b>Total # of cases:</b>", CaseCount))

total_covid_per_city <- LC_covid %>% 
  group_by(City) %>% 
  count()

total_covid <- full_join(total_covid_per_city, larimer_gps, by = "City") %>% 
  na.rm()
```


### Covid cases by city


```{r covid cases}
#total covid cases by city in larimer county

#Creating a new dataset with fewer variables
larimer_short <- larimer_info %>%
  select(Population_Total:Poverty_Per_Capita_Income, TRACTCE)

#Join income vars with larimer_tracts by "TRACTCE", now income vars have coords
#tracts_income <- larimer_tracts %>% left_join(.,larimer_short, by = "TRACTCE") 

data_map <- larimer_tracts %>% 
  left_join(.,larimer_short, by = "TRACTCE") %>%
  rename_all(tolower)

town_latlon <- larimer_gps %>%
  filter(City!="Cedaredge") %>%
  rename_all(tolower)
cases <- LC_covid_gps %>%
  filter(City!="Cedaredge") %>%
  group_by(City) %>%
  count() %>%
  rename(COVID_Cases = n) %>%
  rename_all(tolower) %>%
  left_join(town_latlon, cases, by="city")


#total covid deaths by city in larimer county
deaths <- covid_deaths %>%
  group_by(city) %>%
  count() 
#  rename("COVID-19 Deaths" = n) 

#Date range for covid cases data collection
LC_covid_gps$ReportedDate %>% range()
```


### Income and poverty maps

*Note. Covid cases Jan 1, 2020 through March 3, 2020*

```{r maps}
#figure for Larimer County population totals
fig_pop <- ggplot(data_map) +
                  geom_sf(aes(fill = population_total)) +
                    geom_point(aes(x=lon, y=lat, size = covid_cases),
                               show.legend = FALSE, cases) +
                    geom_text_repel(aes(x=lon, y=lat, label = city),
                                    town_latlon,
                                    color = "black", show.legend=NA) +
                    scale_fill_viridis(name = "City Population", direction = -1, option = "cividis") +
  ggtitle("Population Totals and Covid Cases (January to March 2020) for Larimer County")  +
  theme_void()
                    fig_pop

#income                                 
fig_income <- ggplot(data_map) +
                  geom_sf(aes(fill = poverty_mean_household_income)) +
                    geom_point(aes(x=lon, y=lat, size = covid_cases),
                               show.legend = FALSE, cases) +
                    geom_text_repel(aes(x=lon, y=lat, label = city),
                                    town_latlon,
                                    color = "black", show.legend=NA) +
                    scale_fill_viridis(name = "USD", direction = -1, option = "cividis") +
  ggtitle("Mean Income")  +
  theme_void()
fig_income

#population density
fig_density <- ggplot(data_map) +
                  geom_sf(aes(fill = population_density_perlandsquaremile)) +
                    geom_point(aes(x=lon, y=lat, size = covid_cases),
                               show.legend = FALSE, cases) +
                    geom_text_repel(aes(x=lon, y=lat, label = city),
                                    town_latlon,
                                    color = "black", show.legend=NA) +
                    scale_fill_viridis(name = "People Per Square Mile", 
                                       direction = -1, option = "cividis") +
  ggtitle("Population Density")  +
  theme_void()
fig_density    

#poverty
fig_poverty <- ggplot(data_map) +
                  geom_sf(aes(fill = percent_poverty_allpeople_income_below_pov_level)) +
                    geom_point(aes(x=lon, y=lat, size = covid_cases),
                               show.legend = FALSE, cases) +
                    geom_text_repel(aes(x=lon, y=lat, label = city),
                                    town_latlon,
                                    color = "black", show.legend=NA) +
                    scale_fill_viridis(name = "Percent", 
                                       direction = -1, option = "cividis") +
  ggtitle("Percent of Population Below the Poverty Level")  +
  theme_void()
fig_poverty   
```

```{r data_map}
df <- data_map %>%
pivot_longer(cols = c("population_total", "poverty_mean_household_income",
           "population_density_perlandsquaremile",
             "percent_poverty_allpeople_income_below_pov_level"),
 names_to = "var", values_to = "val")
```


*ISSUE with combining*
*Looks better than ggarrange(), but only 1 fig shows statistics and label*

```{r map_all, fig.width=6, fig.height=6}
fig_all <- ggplot(df) +
geom_sf(aes(geometry = geometry, fill = val)) +
geom_point(aes(x = lon, y = lat, size = covid_cases),
            show.legend = FALSE, cases) +
geom_text_repel(aes(x=lon, y=lat, label = city),
                              town_latlon,
                              color = "black", show.legend = NA) +
scale_fill_viridis(name = "City Population", direction = -1, option = "cividis") +
ggtitle("Larimer County City Comparrison")  +
theme_void() +
facet_wrap(~var, ncol = 2)
fig_all
```


*FIGURE is all messed up but has all details for each figure*

```{r arrange, fig.width=6, fig.height=6}}
#ggarrange() and ggpatchwork()
#create new obj that is composite of all 4 

comp_plot <- ggarrange(fig_pop, fig_density, fig_income, fig,
                       nrow = 2,  ncol = 4, 
                       labels = c("a", "b", "c", "d"))
comp_plot
```
